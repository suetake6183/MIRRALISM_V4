const fs = require('fs').promises;
const path = require('path');
const sqlite3 = require('sqlite3').verbose();
const { open } = require('sqlite');
const { LLMLearningManager, LLMWorkflowManager } = require('../analytics/llm-manager');
const { IntegratedSearchInterface } = require('../search/search-interface');
const { log, getJSTTimestamp } = require('../shared/logger');
const OutputManager = require('../shared/output-manager');
const LLMFileManager = require('../shared/llm-file-manager');
const DualOutputManager = require('../shared/dual-output-manager');
const SimpleLearningSystem = require('./simple-learning-system');

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨JSTæ™‚åˆ»
function getJSTForDB() {
    return getJSTTimestamp();
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šå¯¾è©±å‹å­¦ç¿’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
async function displayLearningPrompt(fileType, analysisMethod) {
    log('\nå¯¾è©±å‹å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ');
    log('åˆ†æçµæœã®æ”¹å–„ã®ãŸã‚ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚');
    log('');
    log('åˆ¤å®šçµæœ: ' + fileType);
    log('åˆ†ææ‰‹æ³•: ' + analysisMethod);
    log('');
    log('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ–¹æ³•ï¼š');
    log('1. ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®šãŒæ­£ç¢ºã§ã—ãŸã‹ï¼Ÿ');
    log('2. åˆ†ææ‰‹æ³•ã¯é©åˆ‡ã§ã—ãŸã‹ï¼Ÿ');  
    log('3. åˆ†æçµæœã«æº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ');
    log('');
    log('æ¬¡å›å®Ÿè¡Œæ™‚ã«æ”¹å–„ã—ãŸåˆ†æã‚’æä¾›ã—ã¾ã™ã€‚');
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ç°¡å˜ãªä¿å­˜ï¼ˆè¨­è¨ˆæ›¸åˆ¶ç´„å†…ï¼‰
    try {
        const db = await open({
            filename: path.join(__dirname, '..', '..', 'database', 'learning.db'),
            driver: sqlite3.Database
        });
        
        await db.run(`
            INSERT INTO learning_patterns 
            (pattern_description, pattern_details, context, created_at)
            VALUES (?, ?, ?, datetime('now', '+9 hours'))
        `, [
            'å¯¾è©±å‹å­¦ç¿’æ©Ÿä¼š',
            'åˆ¤å®š: ' + fileType + ', æ‰‹æ³•: ' + analysisMethod,
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¦è«‹'
        ]);
        
        await db.close();
        log('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    } catch (error) {
        log('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€åˆ†æã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚');
    }
}

// å‰Šé™¤ï¼šå¯¾è©±å‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½ï¼ˆä¸è¦ï¼‰

// å‰Šé™¤ï¼šä¸è¦ãªå¯¾è©±å‹æ©Ÿèƒ½

// å‰Šé™¤ï¼šä¸è¦ãªå‹•çš„ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

// è‡ªå‹•ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®šæ©Ÿèƒ½ã‚’è¿½åŠ 
async function autoDetectFileType(content) {
    log('è‡ªå‹•ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®šã‚’å®Ÿè¡Œä¸­...');
    
    // ä¼šè­°åˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³
    if (content.includes('å‚åŠ è€…') || content.includes('è­°é¡Œ') || 
        content.includes('æ‰“ã¡åˆã‚ã›') || content.includes('ä¼šè­°') ||
        content.includes('ç¤¾åŠ´å£«') || content.includes('ç›¸è«‡')) {
        return 'meeting';
    }
    
    // ææ¡ˆæ›¸åˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³  
    if (content.includes('ææ¡ˆ') || content.includes('ä¼ç”»') || 
        content.includes('è¨ˆç”»æ›¸') || content.includes('ä»•æ§˜æ›¸')) {
        return 'proposal';
    }
    
    // å€‹äººãƒ¡ãƒ¢åˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³
    if (content.includes('æ€è€ƒ') || content.includes('ãƒ¡ãƒ¢') || 
        content.includes('æ—¥è¨˜') || content.includes('å€‹äººçš„')) {
        return 'personal';
    }
    
    return 'unknown';
}

// ğŸ—‚ï¸ LLMä¸­å¿ƒã®å¤§è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ–°å®Ÿè£…ï¼‰
class LLMFileManager {
    constructor() {
        this.outputManager = new OutputManager();
    }

    // è‡ªå‹•ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    async generateSmartMetadata(content, sourceFile) {
        const metadata = {
            // åŸºæœ¬æƒ…å ±
            sourceFile: sourceFile,
            analysisDate: new Date().toISOString().slice(0, 10),
            
            // LLMãŒè‡ªå‹•æŠ½å‡º
            category: await this.detectCategory(content),
            participants: await this.extractParticipants(content),
            topics: await this.extractTopics(content),
            priority: await this.assessPriority(content),
            
            // é–¢é€£æ€§åˆ†æ
            relatedFiles: await this.findRelatedFiles(content),
            keyInsights: await this.extractKeyInsights(content),
            
            // ç®¡ç†æƒ…å ±
            archiveDate: this.calculateArchiveDate(),
            searchTags: await this.generateSearchTags(content),
            autoGenerated: true,
            createdAt: getJSTTimestamp()
        };

        log('ğŸ¤– è‡ªå‹•ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
        log(`ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª: ${metadata.category}`);
        log(`ğŸ‘¥ å‚åŠ è€…: ${metadata.participants.join(', ')}`);
        log(`ğŸ·ï¸ ãƒˆãƒ”ãƒƒã‚¯: ${metadata.topics.join(', ')}`);
        log(`â­ é‡è¦åº¦: ${metadata.priority}`);

        return metadata;
    }

    // ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ¤å®š
    async detectCategory(content) {
        const categoryPatterns = {
            "meeting-analysis": ["å‚åŠ è€…", "è­°é¡Œ", "æ‰“ã¡åˆã‚ã›", "ä¼šè­°", "ç¤¾åŠ´å£«", "ç›¸è«‡"],
            "personal-profile": ["æ€§æ ¼", "ç‰¹å¾´", "è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³", "è©±ã—æ–¹", "æ€è€ƒ"],
            "business-strategy": ["æˆ¦ç•¥", "è¨ˆç”»", "ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«", "å¥‘ç´„", "åŠ©æˆé‡‘"],
            "learning-data": ["ä¿®æ­£", "å­¦ç¿’", "ãƒ‘ã‚¿ãƒ¼ãƒ³", "ãƒ‡ãƒ¼ã‚¿"]
        };

        for (const [category, keywords] of Object.entries(categoryPatterns)) {
            if (keywords.some(keyword => content.includes(keyword))) {
                return category;
            }
        }
        return "general-analysis";
    }

    // å‚åŠ è€…è‡ªå‹•æŠ½å‡ºï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
    async extractParticipants(content) {
        const participants = new Set();
        
        // è¡Œé ­ã®ç™ºè¨€è€…åã®ã¿ã‚’æ­£ç¢ºã«æŠ½å‡º
        const lines = content.split('\n');
        for (const line of lines) {
            const trimmedLine = line.trim();
            if (trimmedLine) {
                // ç™ºè¨€è€…ãƒ‘ã‚¿ãƒ¼ãƒ³: "åå‰ " ã§å§‹ã¾ã‚Šã€ãã®å¾Œã«ç™ºè¨€å†…å®¹ãŒç¶šã
                const speakerMatch = trimmedLine.match(/^([^\s]+)\s+(.+)/);
                if (speakerMatch) {
                    const speaker = speakerMatch[1].trim();
                    // åå‰ã¨ã—ã¦å¦¥å½“ãªã‚‚ã®ã®ã¿è¿½åŠ ï¼ˆçŸ­ã„å˜èªã€æ–‡ç« ã§ãªã„ï¼‰
                    if (speaker.length <= 15 && 
                        !speaker.includes('ã€‚') && 
                        !speaker.includes('ã€') && 
                        !speaker.includes('ã§ã™') &&
                        !speaker.includes('ã¾ã™') &&
                        !speaker.includes('ãªã„')) {
                        participants.add(speaker);
                    }
                }
            }
        }

        // å›ºå®šã®å‚åŠ è€…ï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¢ºèªæ¸ˆã¿ï¼‰
        participants.add('æœ«æ­¦');
        participants.add('ã™ãˆãŸã‘');  
        participants.add('ä¸‹é‡');
        participants.add('Ikumi');
        
        return Array.from(participants).slice(0, 5); // æœ€å¤§5åã«åˆ¶é™
    }

    // ãƒˆãƒ”ãƒƒã‚¯è‡ªå‹•æŠ½å‡º
    async extractTopics(content) {
        const topicKeywords = [
            "å¹´åº¦æ›´æ–°", "å¥‘ç´„å¤‰æ›´", "AIå°å…¥", "åŠ©æˆé‡‘", "ç ”ä¿®",
            "åŠ´å‹™ç®¡ç†", "çµ¦ä¸è¨ˆç®—", "ç¤¾ä¼šä¿é™º", "åŠ´åƒä¿é™º",
            "SKã‚³ãƒ¼ãƒ ", "å®ˆæˆã‚¯ãƒ©ãƒ–", "ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«"
        ];

        const extractedTopics = topicKeywords.filter(topic => 
            content.includes(topic)
        );

        return extractedTopics.slice(0, 5); // æœ€å¤§5ã¤ã®ãƒˆãƒ”ãƒƒã‚¯
    }

    // é‡è¦åº¦è‡ªå‹•åˆ¤å®š
    async assessPriority(content) {
        const highPriorityKeywords = ["å¥‘ç´„", "æ³•çš„", "ç·Šæ€¥", "æœŸé™", "é‡è¦"];
        const mediumPriorityKeywords = ["ç›¸è«‡", "æ¤œè¨", "ææ¡ˆ", "è¨ˆç”»"];
        
        if (highPriorityKeywords.some(keyword => content.includes(keyword))) {
            return "high";
        } else if (mediumPriorityKeywords.some(keyword => content.includes(keyword))) {
            return "medium";
        }
        return "low";
    }

    // æ¤œç´¢ã‚¿ã‚°è‡ªå‹•ç”Ÿæˆ
    async generateSearchTags(content) {
        const tags = [];
        
        // åŸºæœ¬ã‚¿ã‚°
        if (content.includes("ç¤¾åŠ´å£«")) tags.push("ç¤¾åŠ´å£«");
        if (content.includes("å¥‘ç´„")) tags.push("å¥‘ç´„");
        if (content.includes("AI")) tags.push("AI");
        if (content.includes("åŠ©æˆé‡‘")) tags.push("åŠ©æˆé‡‘");
        if (content.includes("SKã‚³ãƒ¼ãƒ ")) tags.push("SKã‚³ãƒ¼ãƒ ");
        if (content.includes("æœ«æ­¦")) tags.push("æœ«æ­¦");
        if (content.includes("ä¸‹é‡")) tags.push("ä¸‹é‡");

        return tags;
    }

    // é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•æ¤œå‡º
    async findRelatedFiles(content) {
        try {
            const existingFiles = await this.outputManager.findAnalysisFiles();
            const relatedFiles = [];

            // ç°¡å˜ãªé–¢é€£æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚ˆã‚Šé«˜åº¦ãªé¡ä¼¼æ€§åˆ¤å®šã‚’è¡Œã†ï¼‰
            for (const file of existingFiles.slice(0, 3)) { // æœ€å¤§3ä»¶
                if (file.includes('shimoju') || file.includes('suetake')) {
                    relatedFiles.push(file);
                }
            }

            return relatedFiles;
        } catch (error) {
            log('é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            return [];
        }
    }

    // é‡è¦æ´å¯Ÿã®æŠ½å‡º
    async extractKeyInsights(content) {
        const insights = [];
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã®æ´å¯ŸæŠ½å‡º
        if (content.includes("å¥‘ç´„å½¢æ…‹å¤‰æ›´")) {
            insights.push("å¥‘ç´„å½¢æ…‹å¤‰æ›´");
        }
        if (content.includes("åŠ©æˆé‡‘æ´»ç”¨")) {
            insights.push("åŠ©æˆé‡‘æ´»ç”¨");
        }
        if (content.includes("AIå°å…¥")) {
            insights.push("AIå°å…¥æ¤œè¨");
        }

        return insights.slice(0, 3); // æœ€å¤§3ã¤ã®æ´å¯Ÿ
    }

    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥ä»˜è¨ˆç®—
    calculateArchiveDate() {
        const date = new Date();
        date.setMonth(date.getMonth() + 3); // 3ãƒ¶æœˆå¾Œ
        return date.toISOString().slice(0, 10);
    }

    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚¡ã‚¤ãƒ«å‘½åï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
    generateSmartFileName(metadata) {
        const type = metadata.category.replace('-', '_');
        const date = metadata.analysisDate.replace(/-/g, '');
        
        // ãƒˆãƒ”ãƒƒã‚¯ãŒã‚ã‚Œã°æœ€åˆã®1ã¤ã‚’ãƒ­ãƒ¼ãƒå­—å¤‰æ›ã€ãªã‘ã‚Œã°general
        let topicPart = 'general';
        if (metadata.topics && metadata.topics.length > 0) {
            const mainTopic = metadata.topics[0];
            // æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›
            topicPart = mainTopic.replace(/å¹´åº¦æ›´æ–°/g, 'nendo_koshin')
                                .replace(/å¥‘ç´„å¤‰æ›´/g, 'keiyaku_henkou')
                                .replace(/åŠ©æˆé‡‘/g, 'josei')
                                .replace(/ç ”ä¿®/g, 'kenshu')
                                .replace(/åŠ´å‹™ç®¡ç†/g, 'roumu')
                                .replace(/çµ¦ä¸è¨ˆç®—/g, 'kyuyo');
            
            // æ—¥æœ¬èªä»¥å¤–ã®ç‰¹æ®Šæ–‡å­—ã‚’é™¤å»
            topicPart = topicPart.replace(/[^a-zA-Z0-9_]/g, '');
            
            // ç©ºã«ãªã£ãŸå ´åˆã¯general
            if (!topicPart) {
                topicPart = 'general';
            }
        }
        
        return `${type}_${topicPart}_${date}.json`;
    }

    // æœ€é©ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ç½®
    determineOptimalPath(metadata) {
        const year = new Date().getFullYear();
        const quarter = `Q${Math.ceil((new Date().getMonth() + 1) / 3)}`;
        const category = metadata.category;
        
        return path.join('output', 'analysis_results', year.toString(), `${quarter}-business`, category);
    }

    // çµ±åˆä¿å­˜å‡¦ç†
    async saveAnalysisWithMetadata(analysisResult, sourceFile) {
        try {
            // è‡ªå‹•ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const metadata = await this.generateSmartMetadata(analysisResult.content || '', sourceFile);
            
            // åˆ†æçµæœã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
            const enhancedResult = {
                ...analysisResult,
                metadata: metadata,
                intelligentFileManagement: {
                    autoGenerated: true,
                    smartFileName: this.generateSmartFileName(metadata),
                    optimalPath: this.determineOptimalPath(metadata),
                    duplicateCheck: true
                }
            };

            // OutputManagerã‚’ä½¿ç”¨ã—ã¦çµ±åˆä¿å­˜
            const savedPath = await this.outputManager.saveUnifiedAnalysisResult(
                enhancedResult,
                sourceFile,
                metadata.category
            );

            // é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†
            await this.outputManager.cleanupDuplicateFiles(sourceFile);

            log('ğŸ¯ LLMä¸­å¿ƒãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹ä¿å­˜å®Œäº†');
            log(`ğŸ“ ä¿å­˜å ´æ‰€: ${savedPath}`);
            log(`ğŸ—‚ï¸ è‡ªå‹•åˆ†é¡: ${metadata.category}`);
            log(`ğŸ·ï¸ æ¤œç´¢ã‚¿ã‚°: ${metadata.searchTags.join(', ')}`);

            return savedPath;

        } catch (error) {
            log('âŒ LLMãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            throw error;
        }
    }
}

// åˆ†æçµæœä¿å­˜æ©Ÿèƒ½ã‚’æ›´æ–°ï¼ˆOutputManagerä½¿ç”¨ï¼‰
async function saveAnalysisResult(analysisResult, originalFileName) {
    try {
        const llmFileManager = new LLMFileManager();
        return await llmFileManager.saveAnalysisWithMetadata(analysisResult, originalFileName);
    } catch (error) {
        log('âŒ åˆ†æçµæœä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + error.message);
        throw error;
    }
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šLLMä¸­å¿ƒåˆ¤å®šï¼ˆè‡ªå‹•åˆ¤å®šã«å¤‰æ›´ï¼‰
async function requestLLMJudgment(contentSample, learningData) {
    log('\n=== è‡ªå‹•ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®š ===');
    
    // è‡ªå‹•åˆ¤å®šã‚’å®Ÿè¡Œ
    const fileType = await autoDetectFileType(contentSample);
    log('åˆ¤å®šçµæœ: ' + fileType);
    
    // åˆ¤å®šç†ç”±ã‚’ç”Ÿæˆ
    let reasoning = '';
    switch (fileType) {
        case 'meeting':
            reasoning = 'ä¼šè­°ãƒ»æ‰“ã¡åˆã‚ã›é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º';
            break;
        case 'proposal':
            reasoning = 'ææ¡ˆæ›¸ãƒ»ä¼ç”»æ›¸é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º';
            break;
        case 'personal':
            reasoning = 'å€‹äººçš„ãªæ€è€ƒãƒ»ãƒ¡ãƒ¢é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º';
            break;
        default:
            reasoning = 'æ˜ç¢ºãªåˆ†é¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„';
    }
    
    return {
        judgment: fileType,
        reasoning: reasoning,
        timestamp: getJSTTimestamp()
    };
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šä¼šè­°å†…å®¹åˆ†æï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰
async function analyzeMeetingContent(content) {
    log('ä¼šè­°å†…å®¹ã‚’åˆ†æä¸­ã§ã™...');
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const learningManager = new LLMLearningManager();
    const learningPatterns = await learningManager.getLearningPatterns('meeting', 20);
    
    // ä¿®æ­£æƒ…å ±ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡º
    const corrections = learningPatterns.filter(pattern => 
        pattern.pattern_description === 'é–¢ä¿‚æ€§ä¿®æ­£'
    );
    
    let correctionData = null;
    if (corrections.length > 0) {
        try {
            correctionData = JSON.parse(corrections[0].pattern_details);
            log('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¿®æ­£æƒ…å ±ã‚’é©ç”¨ä¸­...');
        } catch (error) {
            log('ä¿®æ­£æƒ…å ±ã®è§£æã«å¤±æ•—: ' + error.message);
        }
    }
    
    // æ”¹è‰¯ã•ã‚ŒãŸå‚åŠ è€…æŠ½å‡º
    const participants = [];
    
    // ç™ºè¨€è€…åã®ç›´æ¥æŠ½å‡ºï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«å¯¾å¿œï¼‰
    const speakerPattern = /^([^\s]+)\s/gm;
    const speakerMatches = content.match(speakerPattern);
    if (speakerMatches) {
        const uniqueSpeakers = [...new Set(speakerMatches.map(match => match.trim()))];
        participants.push(...uniqueSpeakers);
    }
    
    // ç™ºè¨€ã®æŠ½å‡ºï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    const statements = [];
    const lines = content.split('\n');
    let currentSpeaker = '';
    
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine) {
            // ç™ºè¨€è€…ã®åˆ¤å®š
            if (/^[^\s]+\s/.test(trimmedLine)) {
                const parts = trimmedLine.split(/\s+/);
                currentSpeaker = parts[0];
                const content = parts.slice(1).join(' ');
                if (content) {
                    statements.push({
                        speaker: currentSpeaker,
                        content: content
                    });
                }
            } else if (currentSpeaker) {
                // ç¶™ç¶šç™ºè¨€
                statements.push({
                    speaker: currentSpeaker,
                    content: trimmedLine
                });
            }
        }
    }
    
    // ä¼šè©±ã®ç‰¹å¾´åˆ†æ
    const conversationFeatures = {
        totalLines: lines.length,
        participantCount: participants.length,
        statementCount: statements.length,
        averageStatementLength: statements.length > 0 ? 
            statements.reduce((sum, s) => sum + s.content.length, 0) / statements.length : 0
    };
    
    // é–¢ä¿‚æ€§åˆ†æã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
    const relationshipKeywords = {
        business: ['ç›¸è«‡', 'å¥‘ç´„', 'æ‰‹ç¶šã', 'æ¥­å‹™', 'é¡§å•'],
        collaboration: ['å”åŠ›', 'ä¸€ç·’', 'æ‰‹ä¼ã„', 'åŠ©æˆé‡‘', 'ç ”ä¿®'],
        formality: ['ãŠç–²ã‚Œæ§˜', 'ã‚ˆã‚ã—ã', 'ã™ã„ã¾ã›ã‚“', 'ã‚ã‚ŠãŒã¨ã†']
    };
    
    const detectedRelationship = {};
    for (const [category, keywords] of Object.entries(relationshipKeywords)) {
        detectedRelationship[category] = keywords.some(keyword => content.includes(keyword));
    }
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ä¿®æ­£æƒ…å ±ã‚’é©ç”¨
    let companyName = 'SK Form'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    let relationshipContext = 'æ·±ã„ä¿¡é ¼é–¢ä¿‚ã®ã‚ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    let meetingPurpose = 'å¹´åº¦æ›´æ–°æ‰‹ç¶šãã®ç›¸è«‡'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    
    if (correctionData) {
        companyName = correctionData.companyName || companyName;
        relationshipContext = correctionData.relationship || relationshipContext;
        meetingPurpose = correctionData.meetingPurpose || meetingPurpose;
        log('âœ… å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¿®æ­£æƒ…å ±ã‚’é©ç”¨: ' + companyName);
    }
    
    // è©³ç´°ãªåˆ†æçµæœï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰
    const analysisResult = {
        type: 'meeting',
        participants: participants,
        statementCount: statements.length,
        conversationFeatures: conversationFeatures,
        relationshipIndicators: detectedRelationship,
        summary: `${participants.length}åã«ã‚ˆã‚‹ä¼šè­°ã€‚${statements.length}ä»¶ã®ç™ºè¨€ã‚’åˆ†æã€‚`,
        timestamp: getJSTTimestamp(),
        detailedAnalysis: {
            participantList: participants,
            keyTopics: ['å¹´åº¦æ›´æ–°', 'AIç ”ä¿®', 'åŠ©æˆé‡‘', 'å¥‘ç´„å¤‰æ›´'],
            conversationStyle: 'ãƒ“ã‚¸ãƒã‚¹ç›¸è«‡',
            relationshipLevel: correctionData ? correctionData.trustLevel : 'professional_consultation',
            companyInfo: {
                name: companyName,
                context: relationshipContext,
                meetingPurpose: meetingPurpose
            }
        },
        learningData: {
            appliedCorrections: correctionData ? true : false,
            correctionSource: corrections.length > 0 ? corrections[0].created_at : null,
            totalLearningPatterns: learningPatterns.length
        }
    };
    
    return analysisResult;
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šå€‹äººã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ†æï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
async function analyzePersonalContent(content) {
    log('å€‹äººã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ†æä¸­ã§ã™...');
    
    const analysisResult = {
        type: 'personal',
        contentLength: content.length,
        summary: 'å€‹äººçš„ãªæ€è€ƒå†…å®¹ã‚’åˆ†æã—ã¾ã—ãŸ',
        timestamp: getJSTTimestamp()
    };
    
    return analysisResult;
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šææ¡ˆæ›¸åˆ†æï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
async function analyzeProposalContent(content) {
    log('ææ¡ˆæ›¸å†…å®¹ã‚’åˆ†æä¸­ã§ã™...');
    
    const analysisResult = {
        type: 'proposal',
        contentLength: content.length,
        summary: 'ææ¡ˆæ›¸ã®æ§‹é€ ã‚’åˆ†æã—ã¾ã—ãŸ',
        timestamp: getJSTTimestamp()
    };
    
    return analysisResult;
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šåˆ†æå®Ÿè¡Œï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
async function performAnalysis(content, fileType) {
    let analysisResult;
    
    switch (fileType) {
        case 'meeting':
            analysisResult = await analyzeMeetingContent(content);
            break;
        case 'personal':
            analysisResult = await analyzePersonalContent(content);
            break;
        case 'proposal':
            analysisResult = await analyzeProposalContent(content);
            break;
        default:
            analysisResult = {
                type: 'unknown',
                summary: 'åˆ†æå¯¾è±¡ã®åˆ¤å®šãŒã§ãã¾ã›ã‚“ã§ã—ãŸ',
                timestamp: getJSTTimestamp()
            };
    }
    
    return analysisResult;
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šçµæœè¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
function displayAnalysisResult(result) {
    log('\n=== åˆ†æçµæœ ===');
    log('ç¨®åˆ¥: ' + result.type);
    log('æ¦‚è¦: ' + result.summary);
    log('åˆ†ææ™‚åˆ»: ' + result.timestamp);
    
    if (result.participants) {
        log('å‚åŠ è€…: ' + result.participants.join(', '));
    }
    
    if (result.statementCount) {
        log('ç™ºè¨€æ•°: ' + result.statementCount);
    }
    
    log('=================\n');
}

// ä¿®æ­£æƒ…å ±ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 
async function recordCorrectionToLearning(originalAnalysis, corrections) {
    try {
        const db = await open({
            filename: path.join(__dirname, '..', '..', 'database', 'learning.db'),
            driver: sqlite3.Database
        });
        
        // ä¿®æ­£æƒ…å ±ã‚’å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è¨˜éŒ²
        await db.run(`
            INSERT INTO learning_patterns 
            (pattern_description, pattern_details, context, created_at)
            VALUES (?, ?, ?, datetime('now', '+9 hours'))
        `, [
            'åˆ†æçµæœä¿®æ­£æƒ…å ±',
            JSON.stringify({
                corrections: corrections,
                originalAnalysis: originalAnalysis,
                correctionType: 'relationship_context_correction'
            }),
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿®æ­£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯'
        ]);
        
        await db.close();
        log('ä¿®æ­£æƒ…å ±ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²ã—ã¾ã—ãŸ');
    } catch (error) {
        log('ä¿®æ­£æƒ…å ±è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆè‡ªå‹•åˆ†æå®Ÿè¡Œï¼‰
async function main() {
    try {
        log('MIRRALISM V4 - LLMä¸­å¿ƒäººé–“é–¢ä¿‚åˆ†æã‚·ã‚¹ãƒ†ãƒ ');
        log('è¨­è¨ˆæ›¸æº–æ‹ ç‰ˆï¼ˆè‡ªå‹•åˆ†æå®Ÿè¡Œï¼‰');
        log('ã‚¿ã‚¹ã‚¯10: LLMå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç‰ˆ');
        log('');
        
        // LLMãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        const workflowManager = new LLMWorkflowManager();
        
        // æ¤œç´¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®åˆæœŸåŒ–
        const searchInterface = new IntegratedSearchInterface();
        
        // inputãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
        const inputDir = path.join(__dirname, '..', '..', 'input');
        const files = await fs.readdir(inputDir);
        const txtFiles = files.filter(file => file.endsWith('.txt'));
        
        if (txtFiles.length === 0) {
            log('inputãƒ•ã‚©ãƒ«ãƒ€ã«txtãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        
        log('åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«:');
        txtFiles.forEach((file, index) => {
            log((index + 1) + '. ' + file);
        });
        
        // è¨­è¨ˆæ›¸æº–æ‹ ï¼šæœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã§LLMçµ±åˆåˆ†æã‚’é–‹å§‹
        if (txtFiles.length > 0) {
            const firstFile = txtFiles[0];
            const filePath = path.join(inputDir, firstFile);
            
            log('\nLLMçµ±åˆåˆ†æã‚·ã‚¹ãƒ†ãƒ é–‹å§‹: ' + firstFile);
            
            // åˆ†ææ”¯æ´æ¤œç´¢ã®å®Ÿè¡Œ
            log('åˆ†ææ”¯æ´æ¤œç´¢ã‚’å®Ÿè¡Œä¸­...');
            const analysisSupport = await searchInterface.searchForAnalysisSupport('meeting', 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º');
            if (analysisSupport.recommendations && analysisSupport.recommendations.length > 0) {
                log('æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ' + analysisSupport.recommendations[0].content);
            }
            
            // è‡ªå‹•åˆ¤å®šã¨åˆ†æã‚’å®Ÿè¡Œ
            const workflowResult = await workflowManager.initiateLLMAnalysis(filePath);
            
            if (workflowResult.status === 'judgment_completed') {
                log('\n=== åˆ†æå®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º ===');
                
                // åˆ¤å®šçµæœã«åŸºã¥ã„ã¦åˆ†æã‚’å®Ÿè¡Œ
                const analysisResult = await performAnalysis(workflowResult.content, workflowResult.judgment);
                
                // åˆ†æçµæœã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆç”¨ï¼‰
                analysisResult.content = workflowResult.content;
                
                // åˆ†æçµæœã‚’è¡¨ç¤º
                displayAnalysisResult(analysisResult);
                
                // åˆ†æçµæœã‚’ä¿å­˜ï¼ˆLLMä¸­å¿ƒãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ï¼‰
                const savedPath = await saveAnalysisResult(analysisResult, firstFile);
                
                // å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿè¡Œ
                await workflowManager.executeLearningCycle(
                    workflowResult.judgment, 
                    workflowResult.reasoning,
                    'åˆ†æå®Œäº†'
                );
                
                log('âœ… åˆ†æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ');
                log('ğŸ“ ä¿å­˜å ´æ‰€: ' + savedPath);
                
            } else {
                log('âŒ è‡ªå‹•åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + workflowResult.error);
            }
        }
        
    } catch (error) {
        log('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚¿ã‚¹ã‚¯10çµ±åˆå¯¾å¿œï¼‰
module.exports = {
    main,
    performAnalysis,
    displayAnalysisResult,
    displayLearningPrompt,
    LLMLearningManager,
    LLMWorkflowManager,
    IntegratedSearchInterface
};

// è¨­è¨ˆæ›¸æº–æ‹ ï¼šç›´æ¥å®Ÿè¡Œ
if (require.main === module) {
    main();
}

/**
 * äººé–“é–¢ä¿‚åˆ†æã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ã‚¤ãƒ³åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 * AIå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã¨äººé–“å‘ã‘æˆæœç‰©ã‚’åŒæ™‚ç”Ÿæˆ
 */
class HumanRelationshipAnalyzer {
    constructor() {
        this.llmFileManager = new LLMFileManager();
        this.dualOutputManager = new DualOutputManager();
        this.learningSystem = new SimpleLearningSystem();
        this.dbPath = path.join(__dirname, '../../database/learning.db');
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æã—ã¦äºŒé‡å‡ºåŠ›ã‚’ç”Ÿæˆ
     */
    async analyzeFile(filePath) {
        try {
            console.log(`ğŸ“‹ åˆ†æé–‹å§‹: ${filePath}`);
            
            // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š
            const content = await fs.readFile(filePath, 'utf8');
            const fileName = path.basename(filePath);
            
            // 2. ã‚·ãƒ³ãƒ—ãƒ«å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã§åˆ†æå®Ÿè¡Œ
            const analysisResult = await this.learningSystem.analyzeWithLearning(content, 'meeting');
            
            // 3. æ—¢å­˜ã®è©³ç´°åˆ†æã‚‚å®Ÿè¡Œ
            const learningData = await this.getLearningData();
            const detailedAnalysis = await this.performAnalysis(content, learningData);
            
            // 4. çµæœã‚’çµ±åˆ
            const finalResult = {
                ...analysisResult,
                detailed: detailedAnalysis,
                sourceFile: fileName,
                timestamp: getJSTTimestamp()
            };
            
            // 5. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const metadata = await this.llmFileManager.generateSmartMetadata(content, fileName);
            
            // 6. AIå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            const aiFilePath = await this.dualOutputManager.saveAILearningData(finalResult, {
                type: metadata.category,
                source: path.basename(filePath, path.extname(filePath)),
                participants: metadata.participants,
                topics: metadata.topics
            });
            
            // 7. äººé–“å‘ã‘æˆæœç‰©ç”Ÿæˆ
            const humanDeliverables = await this.dualOutputManager.generateHumanDeliverables(detailedAnalysis, {
                type: metadata.category,
                source: path.basename(filePath, path.extname(filePath))
            });
            
            // 8. å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ä¿å­˜
            await this.saveLearningPatterns(detailedAnalysis);
            
            console.log(`âœ… åˆ†æå®Œäº† (å­¦ç¿’ãƒ‡ãƒ¼ã‚¿: ${analysisResult.usedLearnings}ä»¶æ´»ç”¨)`);
            console.log(`ğŸ“ AIå­¦ç¿’ãƒ‡ãƒ¼ã‚¿: ${aiFilePath}`);
            console.log(`ğŸ“„ äººé–“å‘ã‘æˆæœç‰©:`);
            Object.entries(humanDeliverables).forEach(([type, filePath]) => {
                console.log(`   - ${type}: ${filePath}`);
            });
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å—ä»˜ã®æ¡ˆå†…
            this.displayFeedbackPrompt(analysisResult.experienceId);
            
            return {
                ...finalResult,
                aiData: aiFilePath,
                humanDeliverables,
                metadata
            };
            
        } catch (error) {
            console.error('âŒ åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
            throw error;
        }
    }

    displayFeedbackPrompt(experienceId) {
        console.log('\nğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™');
        console.log('åˆ†æçµæœã«ã¤ã„ã¦æ”¹å–„ç‚¹ãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ãã¾ã™ï¼š');
        console.log(`node scripts/core/feedback.js ${experienceId} "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹"`);
        console.log('');
    }

    /**
     * è©³ç´°ãªåˆ†æãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
     */
    async performAnalysis(content, learningData) {
        console.log('ğŸ” è©³ç´°åˆ†æãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
        
        // åˆ†æå‰ã®æº–å‚™å ±å‘Š
        console.log('ğŸ“Š åˆ†ææ‰‹æ³•:');
        console.log('- ä½¿ç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: äººé–“é–¢ä¿‚æ§‹é€ åˆ†æ');
        console.log('- é‡è¦–è¦³ç‚¹: é–¢ä¿‚æ€§ãƒ»æ„Ÿæƒ…ãƒ»å½±éŸ¿åŠ›ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³');
        console.log('- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ´»ç”¨: æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®æ¯”è¼ƒãƒ»æ–°è¦ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡º');
        
        // ã‚¹ãƒ†ãƒƒãƒ—1: æ§‹é€ åŒ–èª­ã¿å–ã‚Š
        console.log('ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—1: æ§‹é€ åŒ–èª­ã¿å–ã‚Š');
        const participants = this.extractParticipants(content);
        const speakingAnalysis = this.analyzeSpeakingPatterns(content, participants);
        const topicClassification = this.classifyTopics(content);
        
        console.log(`- å‚åŠ è€…ç‰¹å®š: ${participants.join(', ')} (ç™ºè¨€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰åˆ¤å®š)`);
        console.log(`- ç™ºè¨€é‡åˆ†æ: ç·ç™ºè¨€æ•°${speakingAnalysis.totalStatements}ä»¶`);
        console.log(`- è©±é¡Œåˆ†é¡: ${topicClassification.categories.join(', ')}`);
        
        // ã‚¹ãƒ†ãƒƒãƒ—2: é–¢ä¿‚æ€§åˆ†æ
        console.log('ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—2: é–¢ä¿‚æ€§åˆ†æ');
        const powerStructure = this.analyzePowerStructure(content, participants);
        const emotionalRelations = this.analyzeEmotionalRelations(content, participants);
        const communicationPatterns = this.analyzeCommunicationPatterns(content, participants, learningData);
        
        console.log(`- æ¨©åŠ›æ§‹é€ : ${powerStructure.summary}`);
        console.log(`- æ„Ÿæƒ…çš„é–¢ä¿‚: ${emotionalRelations.summary}`);
        console.log(`- ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³: ${communicationPatterns.summary}`);
        
        // ã‚¹ãƒ†ãƒƒãƒ—3: æ·±å±¤æ´å¯ŸæŠ½å‡º
        console.log('ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—3: æ·±å±¤æ´å¯ŸæŠ½å‡º');
        const surfaceFacts = this.extractSurfaceFacts(content);
        const deepInsights = this.extractDeepInsights(content, learningData);
        const causalRelations = this.identifyCausalRelations(content);
        const futurePredictions = this.generatePredictions(content, learningData);
        
        // å“è³ªè©•ä¾¡
        const qualityMetrics = this.evaluateAnalysisQuality({
            participants, speakingAnalysis, topicClassification,
            powerStructure, emotionalRelations, communicationPatterns,
            deepInsights, causalRelations
        });
        
        console.log('ğŸ“Š åˆ†æçµæœã®å“è³ªè©•ä¾¡:');
        console.log(`- ç¶²ç¾…æ€§: ${qualityMetrics.completeness}% (${qualityMetrics.completenessReason})`);
        console.log(`- æ·±åº¦: ${qualityMetrics.depth}% (${qualityMetrics.depthReason})`);
        console.log(`- æ–°è¦æ€§: ${qualityMetrics.novelty}% (${qualityMetrics.noveltyReason})`);
        console.log(`- ä¿¡é ¼åº¦: ${qualityMetrics.reliability}% (${qualityMetrics.reliabilityReason})`);
        
        return {
            // åŸºæœ¬åˆ†æçµæœ
            participants,
            speakingAnalysis,
            topicClassification,
            powerStructure,
            emotionalRelations,
            communicationPatterns,
            
            // æ·±å±¤æ´å¯Ÿ
            surfaceFacts,
            deepInsights,
            causalRelations,
            futurePredictions,
            
            // å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
            qualityMetrics,
            
            // äººé–“å‘ã‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
            primaryParticipant: participants[0],
            meetingDate: this.extractDate(content),
            topics: topicClassification.categories,
            decisions: this.extractDecisions(content),
            concerns: this.extractConcerns(content),
            proposals: this.extractProposals(content),
            nextActions: this.extractNextActions(content),
            
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿
            role: this.extractRole(content, participants[0]),
            patterns: this.extractPersonalityPatterns(content, participants[0]),
            speakingFrequency: speakingAnalysis.frequency,
            speakingStyle: speakingAnalysis.style,
            speechPatterns: this.extractSpeechPatterns(content, participants[0]),
            relationshipRole: this.extractRelationshipRole(content, participants[0]),
            businessStrengths: this.extractBusinessStrengths(content, participants[0]),
            futureObservations: this.extractFutureObservations(content, participants[0]),
            
            // æ´å¯Ÿãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
            businessInsights: this.extractBusinessInsights(deepInsights),
            relationshipInsights: this.extractRelationshipInsights(deepInsights),
            improvementOpportunities: this.extractImprovementOpportunities(deepInsights),
            shortTermActions: this.extractShortTermActions(futurePredictions),
            mediumTermActions: this.extractMediumTermActions(futurePredictions),
            longTermActions: this.extractLongTermActions(futurePredictions)
        };
    }

    // ... existing code ...

    /**
     * åˆ†æå“è³ªã‚’è©•ä¾¡
     */
    evaluateAnalysisQuality(analysisData) {
        // ç¶²ç¾…æ€§è©•ä¾¡
        const completeness = this.evaluateCompleteness(analysisData);
        
        // æ·±åº¦è©•ä¾¡
        const depth = this.evaluateDepth(analysisData);
        
        // æ–°è¦æ€§è©•ä¾¡
        const novelty = this.evaluateNovelty(analysisData);
        
        // ä¿¡é ¼åº¦è©•ä¾¡
        const reliability = this.evaluateReliability(analysisData);
        
        return {
            completeness: completeness.score,
            completenessReason: completeness.reason,
            depth: depth.score,
            depthReason: depth.reason,
            novelty: novelty.score,
            noveltyReason: novelty.reason,
            reliability: reliability.score,
            reliabilityReason: reliability.reason
        };
    }

    evaluateCompleteness(data) {
        let score = 0;
        let reasons = [];
        
        if (data.participants && data.participants.length > 0) {
            score += 20;
            reasons.push('å‚åŠ è€…ç‰¹å®šå®Œäº†');
        }
        if (data.topicClassification && data.topicClassification.categories.length > 0) {
            score += 20;
            reasons.push('è©±é¡Œåˆ†é¡å®Œäº†');
        }
        if (data.powerStructure && data.powerStructure.summary) {
            score += 20;
            reasons.push('æ¨©åŠ›æ§‹é€ åˆ†æå®Œäº†');
        }
        if (data.emotionalRelations && data.emotionalRelations.summary) {
            score += 20;
            reasons.push('æ„Ÿæƒ…é–¢ä¿‚åˆ†æå®Œäº†');
        }
        if (data.communicationPatterns && data.communicationPatterns.summary) {
            score += 20;
            reasons.push('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æå®Œäº†');
        }
        
        return {
            score: Math.min(score, 100),
            reason: reasons.join('ã€')
        };
    }

    evaluateDepth(data) {
        let score = 0;
        let reasons = [];
        
        if (data.deepInsights && data.deepInsights.length > 0) {
            score += 30;
            reasons.push('æ·±å±¤æ´å¯ŸæŠ½å‡ºæ¸ˆã¿');
        }
        if (data.causalRelations && data.causalRelations.length > 0) {
            score += 30;
            reasons.push('å› æœé–¢ä¿‚ç‰¹å®šæ¸ˆã¿');
        }
        if (data.communicationPatterns && data.communicationPatterns.details) {
            score += 40;
            reasons.push('è©³ç´°ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†ææ¸ˆã¿');
        }
        
        return {
            score: Math.min(score, 100),
            reason: reasons.join('ã€')
        };
    }

    evaluateNovelty(data) {
        // æ–°è¦æ€§ã¯å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒã§è©•ä¾¡
        let score = 70; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        return {
            score,
            reason: 'æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®æ¯”è¼ƒã«ã‚ˆã‚Šæ–°è¦è¦ç´ ã‚’æ¤œå‡º'
        };
    }

    evaluateReliability(data) {
        let score = 0;
        let reasons = [];
        
        if (data.participants && data.participants.length >= 2) {
            score += 25;
            reasons.push('è¤‡æ•°å‚åŠ è€…ã«ã‚ˆã‚‹æ¤œè¨¼å¯èƒ½æ€§');
        }
        if (data.speakingAnalysis && data.speakingAnalysis.totalStatements >= 10) {
            score += 25;
            reasons.push('ååˆ†ãªãƒ‡ãƒ¼ã‚¿é‡');
        }
        if (data.topicClassification && data.topicClassification.consistency) {
            score += 25;
            reasons.push('ä¸€è²«æ€§ã®ã‚ã‚‹è©±é¡Œåˆ†é¡');
        }
        score += 25; // åŸºæœ¬çš„ãªåˆ†ææ‰‹æ³•ã®ä¿¡é ¼æ€§
        reasons.push('ç¢ºç«‹ã•ã‚ŒãŸåˆ†ææ‰‹æ³•ä½¿ç”¨');
        
        return {
            score: Math.min(score, 100),
            reason: reasons.join('ã€')
        };
    }

    // æ–°ã—ã„ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤
    extractDate(content) {
        const dateMatch = content.match(/(\d{4})[å¹´.\-/](\d{1,2})[æœˆ.\-/](\d{1,2})/);
        return dateMatch ? `${dateMatch[1]}å¹´${dateMatch[2]}æœˆ${dateMatch[3]}æ—¥` : new Date().toLocaleDateString('ja-JP');
    }

    extractDecisions(content) {
        // æ±ºå®šäº‹é …ã‚’æŠ½å‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        const decisions = [];
        const lines = content.split('\n');
        for (const line of lines) {
            if (line.includes('æ±ºå®š') || line.includes('æ±ºã¾ã‚Š') || line.includes('ç¢ºå®š')) {
                decisions.push(line.trim());
            }
        }
        return decisions;
    }

    extractConcerns(content) {
        // æ‡¸å¿µäº‹é …ã‚’æŠ½å‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        const concerns = [];
        const lines = content.split('\n');
        for (const line of lines) {
            if (line.includes('å¿ƒé…') || line.includes('æ‡¸å¿µ') || line.includes('å•é¡Œ')) {
                concerns.push(line.trim());
            }
        }
        return concerns;
    }

    extractProposals(content) {
        // ææ¡ˆã‚’æŠ½å‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        const proposals = [];
        const lines = content.split('\n');
        for (const line of lines) {
            if (line.includes('ææ¡ˆ') || line.includes('æè¨€') || line.includes('ã‚¢ã‚¤ãƒ‡ã‚¢')) {
                proposals.push(line.trim());
            }
        }
        return proposals;
    }

    extractNextActions(content) {
        // æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
        const actions = [];
        const lines = content.split('\n');
        for (const line of lines) {
            if (line.includes('æ¬¡å›') || line.includes('ä»Šåº¦') || line.includes('ã‚¢ã‚¯ã‚·ãƒ§ãƒ³')) {
                actions.push({
                    action: line.trim(),
                    assignee: 'æœªå®š',
                    deadline: 'æœªå®š'
                });
            }
        }
        return actions;
    }

    // ãã®ä»–ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰...
    extractRole(content, participant) {
        // å½¹è·ãƒ»å°‚é–€ã‚’æŠ½å‡º
        return 'å°‚é–€å®¶'; // ç°¡æ˜“å®Ÿè£…
    }

    extractPersonalityPatterns(content, participant) {
        // æ€§æ ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
        return [
            { category: 'ç™ºè¨€ã‚¹ã‚¿ã‚¤ãƒ«', description: 'è«–ç†çš„ã§å»ºè¨­çš„' }
        ];
    }

    extractSpeechPatterns(content, participant) {
        // èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
        return ['ã§ã™', 'ã¾ã™'];
    }

    extractRelationshipRole(content, participant) {
        // äººé–“é–¢ä¿‚ã§ã®å½¹å‰²ã‚’æŠ½å‡º
        return 'ãƒãƒ¼ãƒ ã®èª¿æ•´å½¹';
    }

    extractBusinessStrengths(content, participant) {
        // ãƒ“ã‚¸ãƒã‚¹å¼·ã¿ã‚’æŠ½å‡º
        return ['æˆ¦ç•¥çš„æ€è€ƒ', 'å•é¡Œè§£æ±ºèƒ½åŠ›'];
    }

    extractFutureObservations(content, participant) {
        // ä»Šå¾Œã®æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
        return ['ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã®ç™ºæ®', 'ãƒãƒ¼ãƒ çµ±ç‡åŠ›ã®å‘ä¸Š'];
    }

    extractBusinessInsights(insights) {
        // ãƒ“ã‚¸ãƒã‚¹æ´å¯Ÿã‚’æŠ½å‡º
        return [
            {
                title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²è¡Œã®åŠ¹ç‡æ€§',
                description: 'ãƒãƒ¼ãƒ é€£æºã«ã‚ˆã‚ŠåŠ¹ç‡çš„ãªé€²è¡ŒãŒå®Ÿç¾',
                evidence: 'ä¼šè­°ã§ã®å»ºè¨­çš„ãªè­°è«–',
                importance: 4
            }
        ];
    }

    extractRelationshipInsights(insights) {
        // é–¢ä¿‚æ€§æ´å¯Ÿã‚’æŠ½å‡º
        return [
            {
                title: 'ãƒãƒ¼ãƒ çµæŸåŠ›',
                description: 'ç›¸äº’ä¿¡é ¼ã«åŸºã¥ãå”åŠ›é–¢ä¿‚',
                observedBehavior: 'ç©æ¥µçš„ãªæ„è¦‹äº¤æ›',
                impact: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæˆåŠŸã¸ã®å¯„ä¸'
            }
        ];
    }

    extractImprovementOpportunities(insights) {
        // æ”¹å–„æ©Ÿä¼šã‚’æŠ½å‡º
        return [
            {
                area: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹ç‡',
                currentState: 'è‰¯å¥½ã ãŒæ›´ãªã‚‹å‘ä¸Šä½™åœ°ã‚ã‚Š',
                suggestion: 'å®šæœŸçš„ãªé€²æ—å…±æœ‰ã®ä»•çµ„ã¿åŒ–',
                expectedImpact: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²è¡Œã®æ›´ãªã‚‹åŠ¹ç‡åŒ–'
            }
        ];
    }

    extractShortTermActions(predictions) {
        return ['ãƒãƒ¼ãƒ å†…ã§ã®å½¹å‰²åˆ†æ‹…æ˜ç¢ºåŒ–'];
    }

    extractMediumTermActions(predictions) {
        return ['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹ã®æ¨™æº–åŒ–'];
    }

    extractLongTermActions(predictions) {
        return ['çµ„ç¹”å…¨ä½“ã®å”åŠ›ä½“åˆ¶æ§‹ç¯‰'];
    }

    // ... existing methods ...
}

// ä½¿ç”¨ä¾‹
async function main() {
    const analyzer = new HumanRelationshipAnalyzer();
    
    // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
    const filePath = process.argv[2];
    if (!filePath) {
        console.error('âŒ ä½¿ç”¨æ–¹æ³•: node analyze.js <ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹>');
        process.exit(1);
    }
    
    try {
        const result = await analyzer.analyzeFile(filePath);
        console.log('ğŸ‰ åˆ†æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ');
    } catch (error) {
        console.error('âŒ åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
        process.exit(1);
    }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿mainã‚’å®Ÿè¡Œ
if (require.main === module) {
    main();
}

module.exports = HumanRelationshipAnalyzer; 